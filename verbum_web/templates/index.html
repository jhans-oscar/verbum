<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Verbum — Scripture Lookup</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
  <div class="container">
    <header>
      <h1>Verbum</h1>
      <p>Search the Bible by reference or keyword</p>
    </header>

    <form id="lookup-form"
          class="lookup-form"
          hx-get="{{ request.url_for('lookup') }}"
          hx-target="#results"
          hx-swap="none"
          hx-headers='{"Accept":"application/json"}'>
      <label class="sr-only" for="lookup-input">Lookup query</label>
      <input
        type="text"
        id="lookup-input"
        name="query"
        placeholder="Type a reference (e.g. “John 3:16”) or keyword..."
        value="{{ query if query else '' }}"
        autocomplete="off"
        required
      >
      <input type="hidden" name="page" value="1">
      <input type="hidden" name="per_page" value="{{ per_page if per_page else 20 }}">
      <button type="submit">Search</button>
    </form>

    <section id="results" class="results">
      <p class="empty-state">Enter a Bible reference or keyword to begin.</p>
    </section>

    <footer>
      <p>Verbum © 2025 — Personal project by Jhans Oscar</p>
    </footer>
  </div>

  <script src="https://unpkg.com/htmx.org@1.9.12"></script>
  <script>
    (function () {
      const form = document.getElementById('lookup-form');
      const queryInput = document.getElementById('lookup-input');
      const pageInput = form.querySelector('input[name="page"]');
      const perPageInput = form.querySelector('input[name="per_page"]');
      const resultsContainer = document.getElementById('results');
      let lastQuery = (queryInput.value || '').trim();

      function escapeHtml(value) {
        return String(value)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      }

      function renderReference(result) {
        if (!result || !Array.isArray(result.verses) || !result.verses.length) {
          return '<div class="passage-card empty"><p>No passage found.</p></div>';
        }

        const heading = escapeHtml(result.reference ?? 'Passage');
        const listItems = result.verses.map((verse) => {
          const number = verse.number ? `<span class="verse-number">${escapeHtml(verse.number)}</span>` : '';
          const text = `<span class="verse-text">${escapeHtml(verse.text ?? '')}</span>`;
          return `<li class="verse-item">${number}${text}</li>`;
        }).join('');

        return `
          <article class="passage-card">
            <header class="passage-header">
              <h2>${heading}</h2>
              <span class="passage-count">${result.verses.length} verse${result.verses.length === 1 ? '' : 's'}</span>
            </header>
            <ol class="verse-list">${listItems}</ol>
          </article>
        `;
      }

      function renderPagination(data) {
        if (!data || data.total <= data.per_page) {
          return '';
        }

        const totalPages = Math.max(1, Math.ceil(data.total / data.per_page));
        let html = '<div class="pagination">';

        if (data.page > 1) {
          const prevVals = JSON.stringify({ page: data.page - 1 });
          html += `
            <button type="button"
                    class="page-btn"
                    hx-get="/lookup"
                    hx-target="#results"
                    hx-swap="none"
                    hx-include="#lookup-form"
                    hx-headers='{"Accept":"application/json"}'
                    hx-vals='${prevVals}'>
              Previous
            </button>
          `;
        }

        html += `<span class="page-indicator">Page ${data.page} of ${totalPages}</span>`;

        if (data.page < totalPages) {
          const nextVals = JSON.stringify({ page: data.page + 1 });
          html += `
            <button type="button"
                    class="page-btn"
                    hx-get="/lookup"
                    hx-target="#results"
                    hx-swap="none"
                    hx-include="#lookup-form"
                    hx-headers='{"Accept":"application/json"}'
                    hx-vals='${nextVals}'>
              Next
            </button>
          `;
        }

        html += '</div>';
        return html;
      }

      function renderKeyword(data) {
        if (!data.results || data.results.length === 0) {
          return '<p class="empty-state">No results found.</p>';
        }

        const header = `
          <div class="summary-card">
            <h2>Results for “${escapeHtml(data.query)}”</h2>
            <p>${data.total} verse${data.total === 1 ? '' : 's'} found</p>
          </div>
        `;

        const groupsHtml = data.results.map((group) => {
          const verses = (group.verses || []).map((verse) => `
            <li>
              <span class="verse-ref">${escapeHtml(verse.reference)}</span>
              <span class="verse-text">${escapeHtml(verse.text)}</span>
            </li>
          `).join('');

          return `
            <article class="group-card">
              <header class="group-header">
                <h3>${escapeHtml(group.book)}</h3>
                <span>${group.count} verse${group.count === 1 ? '' : 's'}</span>
              </header>
              <ul class="group-list">${verses}</ul>
            </article>
          `;
        }).join('');

        const pagination = renderPagination(data);
        const truncated = data.truncated
          ? '<p class="results-note">Showing the first set of matches. Refine your search to narrow results.</p>'
          : '';

        return `${header}${groupsHtml}${truncated}${pagination}`;
      }

      function render(data) {
        if (!data || !data.mode) {
          resultsContainer.innerHTML = '<p class="empty-state">Nothing to display.</p>';
          return;
        }

        if (data.mode === 'reference') {
          queryInput.value = data.query ?? queryInput.value;
          pageInput.value = '1';
          resultsContainer.innerHTML = renderReference(data.result);
        } else if (data.mode === 'keyword') {
          queryInput.value = data.query ?? queryInput.value;
          perPageInput.value = data.per_page;
          pageInput.value = data.page;
          resultsContainer.innerHTML = renderKeyword(data);
        } else {
          resultsContainer.innerHTML = '<p class="empty-state">Nothing to display.</p>';
        }
        lastQuery = (queryInput.value || '').trim();
      }

      document.body.addEventListener('htmx:beforeRequest', (event) => {
        if (event.target === form) {
          const currentQuery = (queryInput.value || '').trim();
          if (currentQuery !== lastQuery) {
            pageInput.value = '1';
          }
        }
      });

      document.body.addEventListener('htmx:afterRequest', (event) => {
        const target = event.target;
        if (target !== form && !target.classList.contains('page-btn')) {
          return;
        }

        const xhr = event.detail.xhr;
        let payload = null;
        try {
          payload = JSON.parse(xhr.responseText);
        } catch (err) {
          payload = null;
        }

        if (!event.detail.successful) {
          const message = payload && payload.detail
            ? escapeHtml(payload.detail)
            : 'Unable to process the request.';
          resultsContainer.innerHTML = `<p class="empty-state">${message}</p>`;
          return;
        }

        if (!payload) {
          resultsContainer.innerHTML = '<p class="empty-state">Unexpected response from the server.</p>';
          return;
        }

        render(payload);
      });
    })();
  </script>
</body>
</html>
